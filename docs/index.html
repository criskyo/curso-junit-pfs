<!DOCTYPE html>
<html>
  <head>
    <title>GeeksHubsAcademy.com - Curso de JUnit, Jacoco y Mockito</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Roboto+Condensed);

      body { font-family: 'Droid Serif'}
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      th, td {
        border: 1px solid grey;
        padding: 0.4em;
      }
      table {
        border-collapse: collapse;
      }
      .remark-slide-content {
        font-size: 1.6em;
        padding-left: 6em;
      }
      .remark-slide-content h1 {
        font-size: 1.8em;
        text-align: center;
        letter-spacing: 0.1em;
      }
      .small .remark-code {
        font-size: 0.4em;
      }
      .medium .remark-code {
        font-size: 0.6em;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
    .left-column {
      color: #777;
      width: 20%;
      height: 92%;
      float: left;
    }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
    .right-column {
      width: 75%;
      float: right;
      padding-top: 1em;
    }
    .footer {
        position: absolute;
        bottom: 3em;
        font-family: 'Roboto Condensed', sans-serif;
      }
    .footer .orange {
      color: #FF3D00;
    }
    .toc {
      padding-left: 4em;
      font-size: 1.5em;
    }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle
background-image: url(imgs/bg.jpg)

# Curso de JUnit, Jacoco y Mockito
## Práctica en PFS
.footer.left[
Mariano Eloy Fernández Osca
  .orange[
    geekshubsacademy.com
  ]
]
---
layout: true
background-image: url(imgs/bg.jpg)
---
# Qué vamos a hacer en el curso
.toc[
- Testear 2 clases:
  - SubastaController
  - SubastaManager
- Tipos de Test:
  - Unitarios
  - Integración:
    - @SpringBootTest
    - @WebMvcTest (MockMvc)
    - @JdbcTest
- Refactorizar
- Configurar JaCoCo
- TDD
]
---
# SubastaController
https://gist.github.com/mefernandez/88db27e61f666feb8117b87c3cea9762

```java
@Controller
public class SubastaController {

	private static final String DEFAULT = "default";

	@Autowired
	private ApiProxyFactory proxyFactory;

	@Autowired
	private SubastaApi subastaApi;

	@Autowired
	private SubastaManager subastaManager;

	@Autowired
	private NMBProjectContext nmbProjectContext;

...

	@SuppressWarnings("static-access")
	@RequestMapping
	public String guardarAgregarExcluirBien(
			@RequestParam(value = "idSubasta", required = true) Long idSubasta,
			@RequestParam(value = "idsBien", required = true) String idsBien,
			@RequestParam(value = "lotes", required = false) String lotes,
			@RequestParam(value = "accion", required = true) String accion,
			ModelMap map) {

		String[] arrBien = idsBien.split(",");
		if (subastaApi.ACCION_AGREGAR_BIEN.equals(accion)) {
			String[] arrLotes = lotes.split(",");
			subastaApi.agregarBienes(idSubasta, arrBien, arrLotes);
		} else {
			subastaApi.excluirBienes(idSubasta,arrBien);
		}

		return DEFAULT;
	}

....

}
```
---
# SubastaManager
https://gist.github.com/mefernandez/88db27e61f666feb8117b87c3cea9762
```java
@SuppressWarnings("deprecation")
@Service("subastaManager")
public class SubastaManager implements SubastaApi {

	@Autowired
	private ApiProxyFactory proxyFactory;

	@Autowired
	private GenericABMDao genericDao;

	@Autowired
	private SubastaDao subastaDao;

	@Autowired
	private OficinaDao oficinaDao;

	@Autowired
	private NMBBienDao nmbBienDao;

	@Autowired
	private Executor executor;

	@Resource
	private Properties appProperties;

....

	@Override
	@Transactional(readOnly = false)
	public void guardaInstruccionesLoteSubasta(GuardarInstruccionesDto dto) {
		LoteSubasta loteSubasta = this.getLoteSubasta(Long.parseLong(dto.getIdLote()));

		if (!Checks.esNulo(loteSubasta)) {
			loteSubasta.setInsPujaSinPostores(Checks.esNulo(dto.getPujaSinPostores()) ? null : Float.parseFloat(dto.getPujaSinPostores()));
			loteSubasta.setInsPujaPostoresDesde(Checks.esNulo(dto.getPujaPostoresDesde()) ? null : Float.parseFloat(dto.getPujaPostoresDesde()));
			loteSubasta.setInsPujaPostoresHasta(Checks.esNulo(dto.getPujaPostoresHasta()) ? null : Float.parseFloat(dto.getPujaPostoresHasta()));
			loteSubasta.setInsValorSubasta(Checks.esNulo(dto.getValorSubasta()) ? null : Float.parseFloat(dto.getValorSubasta()));
			loteSubasta.setIns50DelTipoSubasta(Checks.esNulo(dto.getTipoSubasta50()) ? null : Float.parseFloat(dto.getTipoSubasta50()));
			loteSubasta.setIns60DelTipoSubasta(Checks.esNulo(dto.getTipoSubasta60()) ? null : Float.parseFloat(dto.getTipoSubasta60()));
			loteSubasta.setIns70DelTipoSubasta(Checks.esNulo(dto.getTipoSubasta70()) ? null : Float.parseFloat(dto.getTipoSubasta70()));
			loteSubasta.setObservaciones(Checks.esNulo(dto.getObservaciones()) ? null : HtmlUtils.htmlUnescape(dto.getObservaciones()));
			if (!Checks.esNulo(dto.getRiesgoConsignacion())) {
				DDSiNo sino = (DDSiNo)diccionarioApi.dameValorDiccionarioByCod(DDSiNo.class, dto.getRiesgoConsignacion());
				loteSubasta.setRiesgoConsignacion(sino!=null && DDSiNo.SI.equals(sino.getCodigo()));
			}
			loteSubasta.setDeudaJudicial(Checks.esNulo(dto.getDeudaJudicial()) ? null : Float.parseFloat(dto.getDeudaJudicial()));
			genericDao.update(LoteSubasta.class, loteSubasta);

			//Calculamos el tipo de subasta en este momento
			subastaProcedimientoApi.determinarTipoSubasta(loteSubasta.getSubasta());  // <<<<<<<<< Este método cambia el estado de la subasta según los valores actuales.
		}

	}

...

}

```
---
# Spring 2.5.x (Release: 2007)
.toc[
![](imgs/bttf.jpg)
]
---
# Agenda (Tareas):
.toc[
1. Montar proyecto con Spring Boot 1.5.9 (Spring 4.2)
2. Crear Test Unitario para SubastaController
3. Separar Tests Unitarios de Tests de Integración
4. Usar de Mockito
5. Configurar JaCoCo
6. Probar capa web de SubastaController
7. Refactorizar SubastaController
]
---
# Montar proyecto con Spring Boot 1.5.9 (Spring 4.2)

1. Abrir Eclipse
2. Descargar un proyecto Spring prototipo
http://start.spring.io/
![](imgs/spring-starter.png)
3.
3. Importar en Eclipse
4. Copiar y pegar la clase SubastaController
5. Testear el método `guardarAgregarExcluirBien`
---
# Spring 2.5

```
git checkout spring25
```
---
# Spring 2.5
`org.springframework.core.JdkVersion`

```
static {
  javaVersion = System.getProperty("java.version");
  // version String should look like "1.4.2_10"
  if (javaVersion.indexOf("1.7.") != -1) {
    majorJavaVersion = JAVA_17;
  }
  else if (javaVersion.indexOf("1.6.") != -1) {
    majorJavaVersion = JAVA_16;
  }
  else if (javaVersion.indexOf("1.5.") != -1) {
    majorJavaVersion = JAVA_15;
  }
  else {
    // else leave 1.4 as default (it's either 1.4 or unknown)
    majorJavaVersion = JAVA_14;
  }
}
```

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        highlightLines: true,
        ratio: '16:9'
      });
    </script>
  </body>
</html>
